<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>YoloV7 æ ‡ç­¾åŒ¹é…åŠ loss è®¡ç®—è§£æ</title>
  <meta name="description" content="ğŸæœ¬ç¯‡æ–‡ç« ä¸»è¦å¯¹ YoloV7 çš„åå¤„ç†è¿›è¡Œè¯¦ç»†è®²è§£ï¼ŒYoloV7 é™¤äº†ç»“æ„ä¸Šï¼Œå¯¹å‰åå¤„ç†éƒ½è¿›è¡Œäº†æ”¹è¿›ï¼Œå…¶ä½™åŒ…æ‹¬ schedulerã€optimizer ç­‰ä¸ YoloV6 éƒ½æ˜¯ä¿æŒä¸€è‡´çš„ã€‚è€Œå‰å¤„ç†ä¸­çš„å¤šæ•° trick ä¹Ÿå¯ä»¥ç”±å…¶ä»–ï¼Œä¾‹å¦‚ X ä¸­çš„æ•°æ®å¢å¼ºæ–¹å¼æ›¿ä»£ã€‚">
  <!-- ç°ä»£å¤šå°ºå¯¸å›¾æ ‡ -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon-16x16.png">
  <link rel="shortcut icon" href="/assets/img/favicon.ico" />
  <link rel="manifest" href="/assets/img/site.webmanifest" />


  <!-- Google Fonts loaded here depending on setting in _data/options.yml true loads font, blank does not-->
  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  
  
<!-- Load up MathJax script if needed ... specify in /_data/options.yml file-->
  
    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: [
      "MathMenu.js",
      "MathZoom.js",
      "AssistiveMML.js",
      "a11y/accessibility-menu.js"
    ],
    jax: ["input/TeX", "output/CommonHTML"],
    TeX: {
      extensions: [
        "AMSmath.js",
        "AMSsymbols.js",
        "noErrors.js",
        "noUndefined.js",
      ]
    }
  });
</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>  


  <link rel="stylesheet" type="text/css" href="/css/tufte.css">
  <!-- <link rel="stylesheet" type="text/css" href="/css/print.css" media="print"> -->

  <link rel="canonical" href="https://froml77.top//ai/2022/11/06/yolov7.html">

  <link rel="alternate" type="application/rss+xml" title="From L77" href="https://froml77.top//feed.xml" />
</head>

  <body>
    <!--- Header and pages template site-wide -->
<header>
    <nav class="group">
	<a href="/"><img class="badge" src="/assets/img/favicon.png" alt="CH"></a>
	
		
<!--		<input type="radio" id="blog" name="nav" class="nav-input">-->
		<a href="https://froml77.top//nav/blog/index.html" class="nav-link">blog</a>
  	
		
<!--		<input type="radio" id="archive" name="nav" class="nav-input">-->
		<a href="https://froml77.top//nav/archive.html" class="nav-link">archive</a>
  	
		
<!--		<input type="radio" id="about" name="nav" class="nav-input">-->
		<a href="https://froml77.top//nav/about.html" class="nav-link">about</a>
  	
	<!-- å³ä¾§æœç´¢æ¡† -->
	<div class="navbar-right">
	  <div class="search-container">
		<input type="text" id="search-input" placeholder="search blog..." />
		<div id="search-results" class="search-results"></div>
	  </div>
	</div>
	</nav>


	<script>
        // é¡µé¢åŠ è½½æ—¶è®¾ç½®æ¿€æ´»çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
<!--            const currentPage = window.location.pathname.split('/').pop();-->
            const currentPage = window.location.href;

            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                }
            });
        });


        // å¯¼èˆªç‚¹å‡»å¤„ç†ï¼ˆå¯é€‰ï¼Œç”¨äºå•é¡µåº”ç”¨ï¼‰
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                // å¦‚æœæ˜¯å•é¡µåº”ç”¨ï¼Œå–æ¶ˆæ³¨é‡Šä»¥ä¸‹ä»£ç ï¼š
                e.preventDefault();
                window.location.href = this.href;
                history.pushState({}, '', this.href);
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });
    </script>
</header>
    <article>
        <div class="container">
          <nav class="toc" id="toc"></nav>
          <main class="content">
            <h1 style="text-align: left">YoloV7 æ ‡ç­¾åŒ¹é…åŠ loss è®¡ç®—è§£æ</h1>
            
            
            
            <p class="subtitle" style="text-align:right"><span style="color: #c7eeeb; font-style: inherit; font-family: Gill Sans">Category:</span><span style="color: #082567; font-style: inherit;">&nbsp; AI</span><span style="color: #c7eeeb; font-style: inherit; font-family: Gill Sans">&nbsp;&nbsp;&nbsp;Tag: &nbsp;</span><span style="color: #082567; font-style: inherit;"> DETECTION NOTE</span></p>
            
            <p>ğŸæœ¬ç¯‡æ–‡ç« ä¸»è¦å¯¹ YoloV7 çš„åå¤„ç†è¿›è¡Œè¯¦ç»†è®²è§£ï¼ŒYoloV7 é™¤äº†ç»“æ„ä¸Šï¼Œå¯¹å‰åå¤„ç†éƒ½è¿›è¡Œäº†æ”¹è¿›ï¼Œå…¶ä½™åŒ…æ‹¬ schedulerã€optimizer ç­‰ä¸ YoloV6 éƒ½æ˜¯ä¿æŒä¸€è‡´çš„ã€‚è€Œå‰å¤„ç†ä¸­çš„å¤šæ•° trick ä¹Ÿå¯ä»¥ç”±å…¶ä»–ï¼Œä¾‹å¦‚ X ä¸­çš„æ•°æ®å¢å¼ºæ–¹å¼æ›¿ä»£ã€‚<!--more-->å› æ­¤æˆ‘ä»¬ç€é‡ä»‹ç»åå¤„ç†éƒ¨åˆ†</p>

<figure class="fullwidth"><img src="/assets/yolov7/1.png" /><figcaption></figcaption></figure>

<p>å¦‚ä¸Šå¦‚æ‰€ç¤ºï¼ŒYoloV7 åŒå¤§å¤šæ•°å•é˜¶æ®µç›®æ ‡æ£€æµ‹ç®—æ³•å±äºå¯†é›†æ£€æµ‹ (dense detection)ã€‚ä¸Šå›¾æ˜¯ä¸€ä¸ª 7x7 çš„ç‰¹å¾å›¾çº¢è‰²çš„ç‚¹æ˜¯åŸºäºç‰¹å¾å›¾çš„ç½‘æ ¼ç‚¹ï¼Œè¿›è¡Œåç§»åçš„ç‚¹ï¼Œç„¶ååœ¨å…¶ä¸Šé“ºè®¾ anchor boxï¼Œæ¯ä¸ªç‚¹é“ºè®¾ä¸€å®šæ•°é‡çš„ anchorã€‚å½“ç„¶ä¹Ÿæœ‰ç›´æ¥åœ¨ç½‘æ ¼ç‚¹ä¸Šè¿›è¡Œé“ºè®¾çš„ï¼Œä¸€èˆ¬æ¥è®²æ²¡æœ‰å¤ªå¤§å·®åˆ«ã€‚ä¸‹é¢æˆ‘ä»¬å¼€å§‹ä»‹ç» v7 åå¤„ç†ï¼Œä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šæ ‡ç­¾åŒ¹é…å’Œ loss è®¡ç®—</p>

<h1 id="label-assignment">Label Assignment</h1>

<p>ğŸ“„æ ‡ç­¾åŒ¹é…ä¸»è¦åˆ†ä¸ºä¸¤æ­¥ï¼šå…ˆæ˜¯è¿›è¡Œ<strong>ç²—ç­›</strong>ï¼Œç„¶åæ˜¯è¿›è¡Œ<strong>ç²¾ç­›</strong></p>

<h2 id="find-3-positive">Find-3-Positive</h2>

<p>ğŸ“‘é¡¾åæ€ä¹‰ï¼Œç¬¬ä¸€æ­¥æ˜¯æ‰¾åˆ°ä¸‰ä¸ªæ­£æ ·æœ¬ï¼Œå°±æ˜¯å¯¹äºæ¯ä¸€ä¸ª GT æ‰¾åˆ°ä¸Šå›¾çš„ä¸‰ä¸ª anchor ä½œä¸ºæ­£æ ·æœ¬ã€‚é¦–å…ˆæˆ‘ä»¬å…ˆå¤§æ¦‚è®²ä¸€ä¸‹åŒ¹é…çš„è§„åˆ™</p>

<figure class="fullwidth"><img src="/assets/yolov7/2.png" /><figcaption></figcaption></figure>

<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¯¹äºæ¯ä¸€ä¸ªç½‘æ ¼ï¼Œä¼šè¢«åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼Œ<strong>ç»¿è‰²ç‚¹</strong>æ˜¯ GT ä¸­å¿ƒç‚¹ï¼Œ<strong>è“è‰²ç‚¹</strong>æ˜¯åŒ¹é…ç»™ GT çš„æ­£æ ·æœ¬ç‚¹ã€‚é¦–å…ˆ GT ä¸­å¿ƒç‚¹æ‰€åœ¨çš„ç½‘æ ¼ä¼šè¢«å®šä¹‰ä¸ºæ­£æ ·æœ¬ï¼Œç„¶åæ ¹æ®ä¸­å¿ƒç‚¹åœ¨ç½‘æ ¼çš„ä½ç½®æ¥æ‰¾åˆ°å¦å¤–ä¸¤ä¸ªæ­£æ ·æœ¬ã€‚æ¯”å¦‚åœ¨ä½ç½® 1 æ˜¯å·¦ä¸Šçš„ç‚¹ä¼šè¢«å®šä¹‰ä¸ºå…¶æ­£æ ·æœ¬ï¼Œä½ç½® 2 æ˜¯å³ä¸Šï¼Œä½ç½® 3 æ˜¯å·¦ä¸‹ï¼Œä½ç½® 4 æ˜¯å³ä¸‹</p>

<figure class="fullwidth"><img src="/assets/yolov7/3.png" /><figcaption></figcaption></figure>

<p>ğŸ“šä¸‹é¢æ˜¯ä»£ç çš„æ³¨è§£å’Œè®²è§£ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># na -- num_anchor nt -- num_targets
# targets [nt, 6] [bs_id, cls, x, y, w, h]
</span><span class="n">na</span><span class="p">,</span> <span class="n">nt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">na</span><span class="p">,</span> <span class="n">targets</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># indices for assignment idx
# anch for assignment anchor
</span><span class="n">indices</span><span class="p">,</span> <span class="n">anch</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="c1"># ç”¨äºå°† target æ˜ å°„åˆ°ç‰¹å¾å›¾çš„ç½‘æ ¼ä¸Š
</span><span class="n">gain</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">targets</span><span class="p">.</span><span class="n">device</span><span class="p">).</span><span class="nf">long</span><span class="p">()</span>
<span class="c1"># [na, nt] eg. ai[0, :] = [0, ..., 0] ai[1, :] = [1, ..., 1]
</span><span class="n">ai</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">targets</span><span class="p">.</span><span class="n">device</span><span class="p">).</span><span class="nf">float</span><span class="p">().</span><span class="nf">view</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nt</span><span class="p">)</span>
<span class="c1"># [na, nt, 7]
</span><span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">targets</span><span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ai</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">None</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># é¢„è®¾ 4 ä¸ªæ–¹å‘ä¸Šçš„åç§»
</span><span class="n">g</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">off</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                   <span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">targets</span><span class="p">.</span><span class="n">device</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span> <span class="o">*</span> <span class="n">g</span>
    <span class="c1"># å¯¹æ¯ä¸ªç‰¹å¾å±‚è¿›è¡ŒåŒ¹é…
</span>	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">nl</span><span class="p">):</span>
        <span class="c1"># è·å–ç‰¹å¾å›¾ i çš„ anchors [3, 2]
</span>        <span class="n">anchors</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># gain = [1, 1, w_i, h_i, w_i, h_i, 1]
</span>        <span class="n">gain</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shape</span><span class="p">)[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">targets</span> <span class="o">*</span> <span class="n">gain</span>
        <span class="k">if</span> <span class="n">nt</span><span class="p">:</span>
            <span class="c1"># è·å–æ¯ä¸ª gt ä¸ anchor çš„é•¿ä¹‹é—´çš„æ¯”ä¸å®½ä¹‹é—´çš„æ¯” [na, nt, 2]
</span>            <span class="n">r</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">/</span> <span class="n">anchors</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]</span>
            <span class="c1"># è·å¾—æ¯”å€¼éƒ½å°äºé˜ˆå€¼ anchor_t çš„ mask [na, nt]
</span>            <span class="n">j</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">r</span><span class="p">).</span><span class="nf">max</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">hyp</span><span class="p">[</span><span class="sh">'</span><span class="s">anchor_t</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># è·å¾—æ»¡è¶³æ¡ä»¶çš„ gt [n1, 7]
</span>            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># gt åœ¨è¯¥ç‰¹å¾å›¾ä¸Šçš„åæ ‡
</span>            <span class="n">gxy</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
            <span class="c1"># å°†åæ ‡æ˜ å°„åˆ°ç½‘æ ¼çš„å¯¹ç§°ä½ç½®ï¼Œç½‘æ ¼çš„ 1 å’Œ 4 å¯¹ç§°ï¼Œ2 å’Œ 3 å¯¹ç§°
</span>            <span class="n">gxi</span> <span class="o">=</span> <span class="n">gain</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">-</span> <span class="n">gxy</span>
            <span class="c1"># å¦‚æœåœ¨ç½‘æ ¼ä½ç½® 1ï¼šjã€k å‡ä¸ºçœŸå€¼ï¼Œå³æ‰¾åˆ°äº†å·¦ä¸Šä¸¤ä¸ªæ­£æ ·æœ¬
</span>            <span class="c1"># ä½ç½® 2ï¼šj ä¸ºå‡ï¼Œk ä¸ºçœŸï¼ˆä¸Šï¼‰ ä½†æ­¤æ—¶ä½ç½® 2 æ— æ³•ç¼ºå°‘ä¸€ä¸ªæ­£æ ·æœ¬æ²¡æœ‰è¡¨ç¤º
</span>            <span class="c1"># [n1] [n1]
</span>            <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">gxy</span> <span class="o">%</span> <span class="mf">1.</span> <span class="o">&lt;</span> <span class="n">g</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gxy</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">)).</span><span class="n">T</span>
            <span class="c1"># ç”±ä¸Šè¡Œå°±å¯ä»¥çœ‹å‡ºæ— æ³•è¡¨ç¤º 2 çš„å…¨éƒ¨æ­£æ ·æœ¬ï¼Œå¯¹äºä½ç½® 2 åªèƒ½æ‰¾åˆ°ä¸€ä¸ªæ­£æ ·æœ¬
</span>            <span class="c1"># 3ï¼Œ4 ä½ç½®æ­£æ ·æœ¬æ— æ³•è¡¨ç¤ºï¼Œå› æ­¤è¦å°† 2ï¼Œ3ï¼Œ4 æ˜ å°„åˆ°å¯¹ç§°ä½ç½®ä¸Š
</span>            <span class="c1"># å…¶ä¸­ä½ç½® 1ï¼šj -&gt; 1ã€k -&gt; 1ã€l -&gt; 0ã€m -&gt; 0
</span>            <span class="c1"># å…¶ä¸­ä½ç½® 2ï¼šj -&gt; 0ã€k -&gt; 1ã€l -&gt; 1ã€m -&gt; 0
</span>            <span class="c1"># å…¶ä¸­ä½ç½® 3ï¼šj -&gt; 1ã€k -&gt; 0ã€l -&gt; 0ã€m -&gt; 1
</span>            <span class="c1"># å…¶ä¸­ä½ç½® 4ï¼šj -&gt; 0ã€k -&gt; 0ã€l -&gt; 1ã€m -&gt; 1
</span>            <span class="n">l</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="p">((</span><span class="n">gxi</span> <span class="o">%</span> <span class="mf">1.</span> <span class="o">&lt;</span> <span class="n">g</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gxi</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">)).</span><span class="n">T</span>
            <span class="c1"># [n1 ,5] æ˜¯å¦é€‰å– gt ä¸­å¿ƒç‚¹æ‰€åœ¨ç½‘æ ¼ä¸Šä¸‹å·¦å³å››ä¸ªç½‘æ ¼ä¸ºæ­£æ ·æœ¬
</span>            <span class="c1"># jklm åˆ†åˆ«ä»£è¡¨å·¦ã€ä¸Šã€å³ã€ä¸‹
</span>            <span class="n">j</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">stack</span><span class="p">((</span><span class="n">torch</span><span class="p">.</span><span class="nf">ones_like</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
            <span class="c1"># [5, n1, 7] -&gt; [n2, 7]
</span>            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">repeat</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># [5, n1, 2] -&gt; [n2, 2] è·å¾—åç§»ï¼Œä»¥ä¾¿åé¢å¾—åˆ°ä¸‰ä¸ªæ­£æ ·æœ¬çš„åæ ‡
</span>            <span class="c1"># æ‰€ä»¥è¿™é‡Œçš„ n2 = 3 * n1
</span>            <span class="n">offsets</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">gxy</span><span class="p">)[</span><span class="bp">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">off</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">])[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># æ­£æ ·æœ¬çš„ bs_idxã€clsã€æ¨ªçºµåæ ‡ã€å®½é«˜
</span>        <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">].</span><span class="nf">long</span><span class="p">().</span><span class="n">T</span>
        <span class="n">gxy</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">gwh</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="c1"># è·å¾—æ­£æ ·æœ¬ xy åæ ‡
</span>        <span class="n">gij</span> <span class="o">=</span> <span class="p">(</span><span class="n">gxy</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">).</span><span class="nf">long</span><span class="p">()</span>
        <span class="n">gi</span><span class="p">,</span> <span class="n">gj</span> <span class="o">=</span> <span class="n">gij</span><span class="p">.</span><span class="n">T</span>
        <span class="c1"># æ‰€æœ‰æ­£æ ·æœ¬åŒ¹é…çš„ anchor idx
</span>        <span class="n">a</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">].</span><span class="nf">long</span><span class="p">()</span>
        <span class="n">indices</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gj</span><span class="p">.</span><span class="nf">clamp_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gain</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">gi</span><span class="p">.</span><span class="nf">clamp_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gain</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">anch</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">indices</span><span class="p">,</span> <span class="n">anch</span>
</code></pre></div></div>

<h3 id="ota">OTA</h3>

<p>ğŸ“‘åœ¨è·å¾—åˆæ­¥çš„æ­£æ ·æœ¬åï¼Œç„¶åè¿›è¡Œç¬¬äºŒæ¬¡ç­›é€‰ï¼Œä½¿ç”¨çš„æ˜¯ç®€æ˜“çš„ OTAï¼Œå…¶è®¡ç®—è¿‡ç¨‹æ˜¯ï¼šå…ˆè®¡ç®—æ¯ä¸ª gt ä¸æ‰€æœ‰ anchor çš„ iou å¹¶å°†å‰åçš„ iou ä¹‹å’Œä½œä¸ºè¯¥ gt åŒ¹é…çš„æ­£æ ·æœ¬ä¸ªæ•°ï¼Œç„¶åè®¡ç®—æ¯ä¸€ä¸ª gt å’Œ anchor è®¡ç®— cost æ¥ç¡®å®šæœ€åçš„æ­£æ ·æœ¬ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯é€‰æ­£æ ·æœ¬æ˜¯åŸºäºç¬¬ä¸€æ­¥çš„åŸºç¡€ä¹‹ä¸Š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_targets</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">imgs</span><span class="p">):</span>
    <span class="n">indices</span><span class="p">,</span> <span class="n">anch</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">find_3_positive</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>

    <span class="c1"># [[], [], []]
</span>    <span class="n">matching_bs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>
    <span class="n">matching_as</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>
    <span class="n">matching_gjs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>
    <span class="n">matching_gis</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>
    <span class="n">matching_targets</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>
    <span class="n">matching_anchs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>

    <span class="n">nl</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>    

    <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
		<span class="c1"># å–å‡ºç¬¬ batch_idx çš„ target
</span>        <span class="n">b_idx</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">batch_idx</span>
        <span class="n">this_target</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">b_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">this_target</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
            <span class="c1"># å°† target å®Œå…¨æ˜ å°„å›åŸé•¿åº¦
</span>        <span class="n">txywh</span> <span class="o">=</span> <span class="n">this_target</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">imgs</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">txyxy</span> <span class="o">=</span> <span class="nf">xywh2xyxy</span><span class="p">(</span><span class="n">txywh</span><span class="p">)</span>

        <span class="n">pxyxys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p_cls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p_obj</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">from_which_layer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_b</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_gj</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_gi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_anch</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pi</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="c1"># å–å‡ºç¬¬ i ä¸ª level çš„åŒ¹é…çš„ä¿¡æ¯
</span>            <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gj</span><span class="p">,</span> <span class="n">gi</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># å–å‡ºè¯¥å›¾åœ¨ level åŒ¹é…åˆ°çš„æ ·æœ¬ä¿¡æ¯ mask
</span>            <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">batch_idx</span><span class="p">)</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gj</span><span class="p">,</span> <span class="n">gi</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">gj</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">gi</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>                
            <span class="n">all_b</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">all_a</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">all_gj</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">gj</span><span class="p">)</span>
            <span class="n">all_gi</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span>
            <span class="n">all_anch</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">anch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">from_which_layer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">b</span><span class="p">),))</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
            <span class="c1"># è·å¾—æ‰€æœ‰æ­£æ ·æœ¬çš„é¢„æµ‹ [n, 85]
</span>            <span class="n">fg_pred</span> <span class="o">=</span> <span class="n">pi</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gj</span><span class="p">,</span> <span class="n">gi</span><span class="p">]</span>                
            <span class="n">p_obj</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">fg_pred</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">p_cls</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">fg_pred</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:])</span>

            <span class="n">grid</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">stack</span><span class="p">([</span><span class="n">gi</span><span class="p">,</span> <span class="n">gj</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pxy</span> <span class="o">=</span> <span class="p">(</span><span class="n">fg_pred</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">].</span><span class="nf">sigmoid</span><span class="p">()</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">grid</span><span class="p">)</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">stride</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 
            <span class="n">pwh</span> <span class="o">=</span> <span class="p">(</span><span class="n">fg_pred</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">].</span><span class="nf">sigmoid</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">anch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">stride</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pxywh</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">([</span><span class="n">pxy</span><span class="p">,</span> <span class="n">pwh</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pxyxy</span> <span class="o">=</span> <span class="nf">xywh2xyxy</span><span class="p">(</span><span class="n">pxywh</span><span class="p">)</span>
            <span class="n">pxyxys</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">pxyxy</span><span class="p">)</span>
            <span class="c1"># [n ,4]
</span>        <span class="n">pxyxys</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">pxyxys</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pxyxys</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">p_obj</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">p_obj</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">p_cls</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">p_cls</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">from_which_layer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">from_which_layer</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_b</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">all_b</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_a</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">all_a</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_gj</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">all_gj</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_gi</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">all_gi</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_anch</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">all_anch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># [n, n] è·å–æ¯ä¸€ä¸ª tgt ä¸é¢„æµ‹æ¡†çš„ iou
</span>        <span class="n">pair_wise_iou</span> <span class="o">=</span> <span class="nf">box_iou</span><span class="p">(</span><span class="n">txyxy</span><span class="p">,</span> <span class="n">pxyxys</span><span class="p">)</span>
        <span class="n">pair_wise_iou_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">pair_wise_iou</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
        <span class="c1"># [n, 10] å–ä¸ tgt iou æ’åå‰ 10 çš„é¢„æµ‹æ¡†
</span>        <span class="n">top_k</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">topk</span><span class="p">(</span><span class="n">pair_wise_iou</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">pair_wise_iou</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># [n] å¯¹äºæ¯ä¸ª tgt çš„æ­£æ ·æœ¬ä¸ªæ•°å–ä¸ºä¸Šè¿°å‰ 10 ä¸ª iou çš„å’Œ
</span>        <span class="n">dynamic_ks</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">clamp</span><span class="p">(</span><span class="n">top_k</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">int</span><span class="p">(),</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># [n, n, 80]
</span>        <span class="n">gt_cls_per_image</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">F</span><span class="p">.</span><span class="nf">one_hot</span><span class="p">(</span><span class="n">this_target</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">to</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">nc</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">float</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pxyxys</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">num_gt</span> <span class="o">=</span> <span class="n">this_target</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># [n, n, 80]
</span>        <span class="n">cls_preds_</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">p_cls</span><span class="p">.</span><span class="nf">float</span><span class="p">().</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">repeat</span><span class="p">(</span><span class="n">num_gt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">sigmoid_</span><span class="p">()</span>
            <span class="o">*</span> <span class="n">p_obj</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">repeat</span><span class="p">(</span><span class="n">num_gt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">sigmoid_</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">cls_preds_</span><span class="p">.</span><span class="nf">sqrt_</span><span class="p">()</span>
        <span class="c1"># [n, n] è®¡ç®— cls çš„ä»£ä»·
</span>        <span class="n">pair_wise_cls_loss</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="nf">binary_cross_entropy_with_logits</span><span class="p">(</span>
            <span class="n">torch</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">))</span> <span class="p">,</span> <span class="n">gt_cls_per_image</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="sh">"</span><span class="s">none</span><span class="sh">"</span>
        <span class="p">).</span><span class="nf">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">cls_preds_</span>

        <span class="n">cost</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pair_wise_cls_loss</span>
            <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">pair_wise_iou_loss</span>
        <span class="p">)</span>
        <span class="c1"># [n, n]
</span>        <span class="n">matching_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">gt_idx</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_gt</span><span class="p">):</span>
            <span class="c1"># å¯¹äºæ¯ä¸ª gt é€‰æ‹© cost å‰ dynamic_ks ä¸ªå°çš„é¢„æµ‹æ¡†ä½œä¸ºæ­£æ ·æœ¬
</span>            <span class="n">_</span><span class="p">,</span> <span class="n">pos_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">topk</span><span class="p">(</span>
                <span class="n">cost</span><span class="p">[</span><span class="n">gt_idx</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">dynamic_ks</span><span class="p">[</span><span class="n">gt_idx</span><span class="p">].</span><span class="nf">item</span><span class="p">(),</span> <span class="n">largest</span><span class="o">=</span><span class="bp">False</span>
            <span class="p">)</span>
            <span class="n">matching_matrix</span><span class="p">[</span><span class="n">gt_idx</span><span class="p">][</span><span class="n">pos_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">del</span> <span class="n">top_k</span><span class="p">,</span> <span class="n">dynamic_ks</span>
        <span class="c1"># [n] è®¡ç®—æ¯ä¸ª anchor åŒ¹é…åˆ°äº†å¤šå°‘ä¸ª gt
</span>        <span class="n">anchor_matching_gt</span> <span class="o">=</span> <span class="n">matching_matrix</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">anchor_matching_gt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">).</span><span class="nf">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># [n, am] è·å–åŒ¹é… gt æ•°å¤§äº 1 çš„ anchor ä¸ gt æœ€å°çš„ cost çš„ gt çš„ä¸‹æ ‡
</span>            <span class="n">_</span><span class="p">,</span> <span class="n">cost_argmin</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">cost</span><span class="p">[:,</span> <span class="n">anchor_matching_gt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># å…ˆå…¨éƒ¨ç½®ä¸º 0
</span>            <span class="n">matching_matrix</span><span class="p">[:,</span> <span class="n">anchor_matching_gt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">0.0</span>
            <span class="c1"># å°†ä¸ anchor ä¸­ cost æœ€å°å¯¹åº”çš„ gt è®¾ç½®ä¸ºå®ƒçš„æ­£æ ·æœ¬
</span>            <span class="c1"># è¿™æ ·åšçš„åŸå› æ˜¯å› ä¸ºä¿è¯æ¯ä¸€ä¸ª anchor åªåŒ¹é…åˆ°ä¸€ä¸ª gt
</span>            <span class="n">matching_matrix</span><span class="p">[</span><span class="n">cost_argmin</span><span class="p">,</span> <span class="n">anchor_matching_gt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="c1"># [n] è·å¾— anchor çš„ maskï¼Œå…¶ä¸­ true ä¸ºæ­£æ ·æœ¬ï¼Œåä¹‹ä¸ºè´Ÿæ ·æœ¬
</span>        <span class="n">fg_mask_inboxes</span> <span class="o">=</span> <span class="n">matching_matrix</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
        <span class="c1"># è·å–æ¯ä¸ª anchor åŒ¹é…åˆ° gt çš„ä¸‹æ ‡
</span>        <span class="n">matched_gt_inds</span> <span class="o">=</span> <span class="n">matching_matrix</span><span class="p">[:,</span> <span class="n">fg_mask_inboxes</span><span class="p">].</span><span class="nf">argmax</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># è·å–æ‰€æœ‰æ­£æ ·æœ¬çš„ä¿¡æ¯
</span>        <span class="n">from_which_layer</span> <span class="o">=</span> <span class="n">from_which_layer</span><span class="p">[</span><span class="n">fg_mask_inboxes</span><span class="p">]</span>
        <span class="n">all_b</span> <span class="o">=</span> <span class="n">all_b</span><span class="p">[</span><span class="n">fg_mask_inboxes</span><span class="p">]</span>
        <span class="n">all_a</span> <span class="o">=</span> <span class="n">all_a</span><span class="p">[</span><span class="n">fg_mask_inboxes</span><span class="p">]</span>
        <span class="n">all_gj</span> <span class="o">=</span> <span class="n">all_gj</span><span class="p">[</span><span class="n">fg_mask_inboxes</span><span class="p">]</span>
        <span class="n">all_gi</span> <span class="o">=</span> <span class="n">all_gi</span><span class="p">[</span><span class="n">fg_mask_inboxes</span><span class="p">]</span>
        <span class="n">all_anch</span> <span class="o">=</span> <span class="n">all_anch</span><span class="p">[</span><span class="n">fg_mask_inboxes</span><span class="p">]</span>

        <span class="n">this_target</span> <span class="o">=</span> <span class="n">this_target</span><span class="p">[</span><span class="n">matched_gt_inds</span><span class="p">]</span>
        <span class="c1"># è¿›è¡Œåˆ†å±‚å‚¨å­˜ï¼Œå¾—åˆ°ä¸åŒ level çš„æ­£æ ·æœ¬
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">nl</span><span class="p">):</span>
            <span class="n">layer_idx</span> <span class="o">=</span> <span class="n">from_which_layer</span> <span class="o">==</span> <span class="n">i</span>
            <span class="n">matching_bs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">all_b</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">])</span>
            <span class="n">matching_as</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">all_a</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">])</span>
            <span class="n">matching_gjs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">all_gj</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">])</span>
            <span class="n">matching_gis</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">all_gi</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">])</span>
            <span class="n">matching_targets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">this_target</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">])</span>
            <span class="n">matching_anchs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">all_anch</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">nl</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">matching_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
        	<span class="n">matching_bs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">matching_bs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        	<span class="n">matching_as</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">matching_as</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        	<span class="n">matching_gjs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">matching_gjs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        	<span class="n">matching_gis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">matching_gis</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        	<span class="n">matching_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">matching_targets</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        	<span class="n">matching_anchs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">matching_anchs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matching_bs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([],</span> <span class="n">device</span><span class="o">=</span><span class="sh">'</span><span class="s">cuda:0</span><span class="sh">'</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">matching_as</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([],</span> <span class="n">device</span><span class="o">=</span><span class="sh">'</span><span class="s">cuda:0</span><span class="sh">'</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">matching_gjs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([],</span> <span class="n">device</span><span class="o">=</span><span class="sh">'</span><span class="s">cuda:0</span><span class="sh">'</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">matching_gis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([],</span> <span class="n">device</span><span class="o">=</span><span class="sh">'</span><span class="s">cuda:0</span><span class="sh">'</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">matching_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([],</span> <span class="n">device</span><span class="o">=</span><span class="sh">'</span><span class="s">cuda:0</span><span class="sh">'</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">matching_anchs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([],</span> <span class="n">device</span><span class="o">=</span><span class="sh">'</span><span class="s">cuda:0</span><span class="sh">'</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">matching_bs</span><span class="p">,</span> <span class="n">matching_as</span><span class="p">,</span> <span class="n">matching_gjs</span><span class="p">,</span> <span class="n">matching_gis</span><span class="p">,</span> <span class="n">matching_targets</span><span class="p">,</span> <span class="n">matching_anch</span>
</code></pre></div></div>

<h2 id="loss-computation">Loss Computation</h2>

<p>ğŸ“‘v7 çš„ loss è®¡ç®—åˆ†ä¸ºï¼šåˆ†ç±»æŸå¤±ã€å›å½’æŸå¤±å’Œç›®æ ‡æŸå¤±</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">imgs</span><span class="p">):</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">targets</span><span class="p">.</span><span class="n">device</span>
    <span class="n">lcls</span><span class="p">,</span> <span class="n">lbox</span><span class="p">,</span> <span class="n">lobj</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">bs</span><span class="p">,</span> <span class="n">as_</span><span class="p">,</span> <span class="n">gjs</span><span class="p">,</span> <span class="n">gis</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">anchors</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">build_targets</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">imgs</span><span class="p">)</span>
    <span class="c1"># æ¯ä¸ª level ç‰¹å¾å›¾çš„å®½é«˜
</span>    <span class="n">pre_gen_gains</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">(</span><span class="n">pp</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span> 


    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pi</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="c1"># å–å‡ºç¬¬ level çš„æ­£æ ·æœ¬ä¿¡æ¯
</span>        <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gj</span><span class="p">,</span> <span class="n">gi</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">as_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">gjs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">gis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">tobj</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">pi</span><span class="p">[...,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
            <span class="c1"># è·å¾—æ­£æ ·æœ¬çš„é¢„æµ‹ç»“æœ
</span>            <span class="n">ps</span> <span class="o">=</span> <span class="n">pi</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gj</span><span class="p">,</span> <span class="n">gi</span><span class="p">]</span>

            <span class="c1"># æ­£æ ·æœ¬çš„åæ ‡
</span>            <span class="n">grid</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">stack</span><span class="p">([</span><span class="n">gi</span><span class="p">,</span> <span class="n">gj</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># è¿™é‡Œå¾—åˆ°çš„æ˜¯ç”¨ stride norm è¿‡åçš„é¢„æµ‹æ¡†
</span>            <span class="n">pxy</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">].</span><span class="nf">sigmoid</span><span class="p">()</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">-</span> <span class="mf">0.5</span>
            <span class="n">pwh</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">].</span><span class="nf">sigmoid</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">anchors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pbox</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">pxy</span><span class="p">,</span> <span class="n">pwh</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">selected_tbox</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">pre_gen_gains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># é¢„æµ‹çš„æ˜¯ç¦»æ ¼ç‚¹è·ç¦»ï¼Œå› æ­¤ gt éœ€è¦å‡å»ç›¸åº”æ ¼ç‚¹çš„åæ ‡
</span>            <span class="n">selected_tbox</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">grid</span>
            <span class="n">iou</span> <span class="o">=</span> <span class="nf">bbox_iou</span><span class="p">(</span><span class="n">pbox</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">selected_tbox</span><span class="p">,</span> <span class="n">x1y1x2y2</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">CIoU</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">lbox</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">iou</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>

            <span class="c1"># å°† obj label ä¸­æ­£æ ·æœ¬ä½ç½®è®¾ç½®ä¸ºä¸ gt çš„ iouï¼Œå…¶ä½™ä¸º 0
</span>            <span class="n">tobj</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">gj</span><span class="p">,</span> <span class="n">gi</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">gr</span><span class="p">)</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">gr</span> <span class="o">*</span> <span class="n">iou</span><span class="p">.</span><span class="nf">detach</span><span class="p">().</span><span class="nf">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">type</span><span class="p">(</span><span class="n">tobj</span><span class="p">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="n">selected_tcls</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">long</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">nc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># cls loss åªè®¡ç®—äº†æ­£æ ·æœ¬çš„ loss
</span>                <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">full_like</span><span class="p">(</span><span class="n">ps</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:],</span> <span class="n">self</span><span class="p">.</span><span class="n">cn</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
                <span class="n">t</span><span class="p">[</span><span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">selected_tcls</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cp</span>
                <span class="n">lcls</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nc">BCEcls</span><span class="p">(</span><span class="n">ps</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:],</span> <span class="n">t</span><span class="p">)</span>

            <span class="c1"># obj è®¡ç®—ä¸ºå…¨éƒ¨æ ·æœ¬çš„ loss
</span>            <span class="n">obji</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nc">BCEobj</span><span class="p">(</span><span class="n">pi</span><span class="p">[...,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">tobj</span><span class="p">)</span>
            <span class="n">lobj</span> <span class="o">+=</span> <span class="n">obji</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">balance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># obj loss
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">autobalance</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">balance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">balance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.9999</span> <span class="o">+</span> <span class="mf">0.0001</span> <span class="o">/</span> <span class="n">obji</span><span class="p">.</span><span class="nf">detach</span><span class="p">().</span><span class="nf">item</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">autobalance</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">balance</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">ssi</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">balance</span><span class="p">]</span>
    <span class="n">lbox</span> <span class="o">*=</span> <span class="n">self</span><span class="p">.</span><span class="n">hyp</span><span class="p">[</span><span class="sh">'</span><span class="s">box</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">lobj</span> <span class="o">*=</span> <span class="n">self</span><span class="p">.</span><span class="n">hyp</span><span class="p">[</span><span class="sh">'</span><span class="s">obj</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">lcls</span> <span class="o">*=</span> <span class="n">self</span><span class="p">.</span><span class="n">hyp</span><span class="p">[</span><span class="sh">'</span><span class="s">cls</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">tobj</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># batch size
</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">lbox</span> <span class="o">+</span> <span class="n">lobj</span> <span class="o">+</span> <span class="n">lcls</span>
    <span class="k">return</span> <span class="n">loss</span> <span class="o">*</span> <span class="n">bs</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">lbox</span><span class="p">,</span> <span class="n">lobj</span><span class="p">,</span> <span class="n">lcls</span><span class="p">,</span> <span class="n">loss</span><span class="p">)).</span><span class="nf">detach</span><span class="p">()</span>
</code></pre></div></div>

<p>â˜•Yolov7 å…¶ä»–éƒ¨åˆ†å¦‚ scheduler å’Œ optimizer ä¸ Yolov6 ä¿æŒä¸€è‡´ï¼Œå¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ v7 çš„éšæ€§å±‚å¯ä»¥æç‚¹ 0.5 å·¦å³ï¼Œä½†æ˜¯ä¹Ÿè®¸ä»…é™ v7 åŒæ—¶å¯¹éšæ€§å±‚çš„ lr ç­‰éœ€è¦ç‰¹æ®Šè®¾ç½®</p>

            <p class="subtitle" style="text-align:right"><span style="color: #ffb6c1; font-style: inherit;">November 6, 2022</span></p>
          </main>
        </div>
    </article>
    <script>
    // åŠ¨æ€ç”Ÿæˆæ–‡ç« åˆ—è¡¨ï¼ˆå‡è®¾æ¯ç¯‡æ–‡ç« æœ‰æ ‡é¢˜ã€å†…å®¹å’Œé“¾æ¥ï¼‰
    const articles = [
      
        {
          title: "DETR SERIES",
          content: "ğŸæœ¬ç¯‡æ–‡ç« ä¸»è¦å¯¹ DETR çš„ç›¸å…³ç±»å®¹è¿›è¡Œç®€å•çš„ä»‹ç»ï¼Œå†…å®¹æ¶‰åŠDETRã€Deformable DETRã€DAB-DETRã€DN-DETR å’Œ DINO ç­‰ Transformer åœ¨ç›®æ ‡æ£€æµ‹é¢†åŸŸåº”ç”¨çš„ç®—æ³• # DETR ## Framework {% fullwidth &#39;assets/detr-series/1.png&#39; &quot;&quot; %} DETR ç®—æ˜¯ Transformer åœ¨è§†è§‰é¢†åŸŸåº”ç”¨çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œè‡³å°‘æ˜¯æˆ‘è¯»è¿‡çš„ç¬¬ä¸€ç¯‡ï¼Œå³Â End-to-End Object Detection with Transformersã€‚å¯ä»¥çœ‹å‡º image é€šè¿‡ CNN æˆ–è€… Transformer ä½œä¸º backbone è¿›è¡Œæå– featureï¼Œç„¶åç»è¿‡ Transformer è¿›è¡Œè¿›ä¸€æ­¥çš„ç‰¹å¾æå–ï¼Œæœ€åé€å…¥æ£€æµ‹å¤´é¢„æµ‹ ## Transformer {% fullwidth &#39;assets/detr-series/2.jpg&#39; &quot;&quot; %} æ˜¾ç„¶åœ¨ DETR ä¸­æœ€é‡è¦çš„å°±æ˜¯ Transformer äº†ã€‚å…¶æ˜¯ç”±å¤šä¸ª encoder...",
          url: "/ai/2023/05/19/detr-series.html"
        },
      
        {
          title: "CUDA ç¼–ç¨‹ï¼ˆè¿›é˜¶ç¯‡ï¼‰",
          content: "# General Matrix Multiplication GEMM ä¼˜åŒ–æœ¬èº«æ˜¯ä¸€ä¸ªéå¸¸å€¼å¾—è®¨è®ºçš„è¯¾é¢˜ï¼Œå…¶ä¼˜åŒ–ä¹Ÿæ¶‰åŠ GPU ä¸­ä¼˜åŒ–çš„å¤§å¤šæ•°å¸¸ç”¨çš„æŠ€å·§ã€‚è¿™éƒ¨åˆ†ä»¥è§£æçŸ¥ä¹å¤§ä½¬æœ‰äº†ç¦ç¦çš„æ£å­[æ–‡ç« ](https://zhuanlan.zhihu.com/p/435908830)ä¸­çš„ä»£ç è¿›è¡Œè§£è¯»ï¼Œä¹Ÿä½œä¸ºä»£ç é˜…è¯»ç¬”è®°æ¢³ç†æ•´ä¸ªæ€è·¯ã€‚ é¦–å…ˆï¼Œå…¶ä¼˜åŒ–æŠ€å·§**åˆ†å—è®¡ç®—**ã€**shared memory çš„å¤šæ¬¡åˆ©ç”¨**ã€**register çš„å¤šæ¬¡åˆ©ç”¨**ä»¥åŠ**å„ç§ bank çš„ conflict è§£å†³**ï¼Œæœ‰çš„ç”šè‡³ä¼šæ¶‰åŠåˆ°æ±‡ç¼–å±‚é¢çš„ä¼˜åŒ–ï¼Œè¿™é‡Œæœ‰äº›æŠ€å·§åœ¨åŸºç¡€ç¯‡å·²ç»è®²è¿‡ï¼Œå°±ä¸å†èµ˜è¿°äº†ã€‚ å…¶æ¬¡ï¼Œç®€å•å™è¿°ä¸€ä¸‹ä¼˜åŒ–çš„æ€è·¯ï¼Œä¸»è¦çš„æ€è·¯å°±æ˜¯å¯¹çŸ©é˜µè¿›è¡Œåˆ†å—è®¡ç®—ï¼Œä¸åŒ block è´Ÿè´£è®¡ç®—å‡º C ä¸­çš„ä¸åŒéƒ¨åˆ†ï¼ŒåŒæ—¶åœ¨ block å†…åˆè®©ä¸åŒçº¿ç¨‹è´Ÿè´£ä¸åŒéƒ¨åˆ†ï¼Œè¿™é‡Œé¢ä¸ºäº†èƒ½å¤šæ¬¡åˆ©ç”¨ shared memoryï¼Œéœ€è¦è¿›è¡Œå¤šæ¬¡å¾ªç¯ï¼Œå› æ­¤åœ¨ block å†…æœ‰å¤šæ¬¡å¤§å¾ªç¯ï¼Œåœ¨å¤§å¾ªç¯å†…åˆæœ‰æ¯ä¸ªçº¿ç¨‹ä¸­çš„å¤šæ¬¡å°å¾ªç¯ã€‚å› ä¸ºæ¶‰åŠåˆ°æŠŠæ•°æ®ä¸æ–­æ¬åˆ° shared memoryï¼Œæ‰€ä»¥ä½œè€…è®¾è®¡äº†é¢„å– prefetch çš„åšæ³•ï¼Œè¿™æ ·åšå¯ä»¥æ©ç›– io çš„ latencyï¼Œå› æ­¤ä¹Ÿè¦è®¾è®¡å“ªäº›çº¿ç¨‹æ¬è¿å“ªäº›æ•°æ®ã€‚ç”±äºå¯èƒ½åœ¨è®¿é—® shared memory çš„æ—¶å€™æœ‰ bank conflictï¼Œæ‰€ä»¥ä¹Ÿè¦è®¾è®¡å“ªäº›çº¿ç¨‹è®¿é—®å“ªäº›å†…å­˜ã€‚ ## åˆ†å—è®¡ç®—çš„æ€è·¯ é¦–å…ˆå¦‚ä¸‹å›¾ï¼Œå¯¹ C è¿›è¡Œåˆ†å—ï¼š {% fullwidth &#39;assets/cuda2/1.png&#39; &quot;&quot; %} ç”±å›¾å¯çŸ¥ï¼ŒC...",
          url: "/ai/2023/02/09/cuda2.html"
        },
      
        {
          title: "CUDA ç¼–ç¨‹ï¼ˆåŸºç¡€ç¯‡ï¼‰",
          content: "## ç®€ä»‹ cuda å…³äºçŸ©é˜µç›¸å…³è¿ç®—çš„å…¥é—¨ç¼–ç¨‹åŠç›¸å…³æŠ€å·§ï¼Œæ˜¯æˆ‘çš„å­¦ä¹ ç¬”è®°ï¼Œæ¯”è¾ƒé€‚åˆåˆå­¦è€…ã€‚ ## çŸ©é˜µç›¸åŠ  è¿™ä¸€èŠ‚é€šè¿‡çŸ©é˜µç›¸åŠ æ¥ä»‹ç» cuda ç¼–ç¨‹çš„å¸¸è§„æµç¨‹ï¼Œå¹¶ä»‹ç»ä¸€äº›æœ¯è¯­ ### æµç¨‹ * memory allocÂ  ç”¨äºåœ¨ gpu ä¸Šå¼€è¾Ÿç©ºé—´ ```c++ cudaMalloc((void**) &amp;d_o, sizeof(float) * (M * N)); cudaMalloc((void**) &amp;d_a, sizeof(float) * (M * N)); cudaMalloc((void**) &amp;d_b, sizeof(float) * (M * N)); ``` å…¶ä¸­ M å’Œ N åˆ†åˆ«æ˜¯çŸ©é˜µçš„è¡Œå’Œåˆ— * copy data ```c++ cudaMemcpy(d_o,...",
          url: "/ai/2023/01/01/cuda1.html"
        },
      
        {
          title: "YoloV7 æ ‡ç­¾åŒ¹é…åŠ loss è®¡ç®—è§£æ",
          content: "ğŸæœ¬ç¯‡æ–‡ç« ä¸»è¦å¯¹ YoloV7 çš„åå¤„ç†è¿›è¡Œè¯¦ç»†è®²è§£ï¼ŒYoloV7 é™¤äº†ç»“æ„ä¸Šï¼Œå¯¹å‰åå¤„ç†éƒ½è¿›è¡Œäº†æ”¹è¿›ï¼Œå…¶ä½™åŒ…æ‹¬ schedulerã€optimizer ç­‰ä¸ YoloV6 éƒ½æ˜¯ä¿æŒä¸€è‡´çš„ã€‚è€Œå‰å¤„ç†ä¸­çš„å¤šæ•° trick ä¹Ÿå¯ä»¥ç”±å…¶ä»–ï¼Œä¾‹å¦‚ X ä¸­çš„æ•°æ®å¢å¼ºæ–¹å¼æ›¿ä»£ã€‚å› æ­¤æˆ‘ä»¬ç€é‡ä»‹ç»åå¤„ç†éƒ¨åˆ† å¦‚ä¸Šå¦‚æ‰€ç¤ºï¼ŒYoloV7 åŒå¤§å¤šæ•°å•é˜¶æ®µç›®æ ‡æ£€æµ‹ç®—æ³•å±äºå¯†é›†æ£€æµ‹ (dense detection)ã€‚ä¸Šå›¾æ˜¯ä¸€ä¸ª 7x7 çš„ç‰¹å¾å›¾çº¢è‰²çš„ç‚¹æ˜¯åŸºäºç‰¹å¾å›¾çš„ç½‘æ ¼ç‚¹ï¼Œè¿›è¡Œåç§»åçš„ç‚¹ï¼Œç„¶ååœ¨å…¶ä¸Šé“ºè®¾ anchor boxï¼Œæ¯ä¸ªç‚¹é“ºè®¾ä¸€å®šæ•°é‡çš„ anchorã€‚å½“ç„¶ä¹Ÿæœ‰ç›´æ¥åœ¨ç½‘æ ¼ç‚¹ä¸Šè¿›è¡Œé“ºè®¾çš„ï¼Œä¸€èˆ¬æ¥è®²æ²¡æœ‰å¤ªå¤§å·®åˆ«ã€‚ä¸‹é¢æˆ‘ä»¬å¼€å§‹ä»‹ç» v7 åå¤„ç†ï¼Œä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šæ ‡ç­¾åŒ¹é…å’Œ loss è®¡ç®— Label Assignment ğŸ“„æ ‡ç­¾åŒ¹é…ä¸»è¦åˆ†ä¸ºä¸¤æ­¥ï¼šå…ˆæ˜¯è¿›è¡Œç²—ç­›ï¼Œç„¶åæ˜¯è¿›è¡Œç²¾ç­› Find-3-Positive ğŸ“‘é¡¾åæ€ä¹‰ï¼Œç¬¬ä¸€æ­¥æ˜¯æ‰¾åˆ°ä¸‰ä¸ªæ­£æ ·æœ¬ï¼Œå°±æ˜¯å¯¹äºæ¯ä¸€ä¸ª GT æ‰¾åˆ°ä¸Šå›¾çš„ä¸‰ä¸ª anchor ä½œä¸ºæ­£æ ·æœ¬ã€‚é¦–å…ˆæˆ‘ä»¬å…ˆå¤§æ¦‚è®²ä¸€ä¸‹åŒ¹é…çš„è§„åˆ™ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¯¹äºæ¯ä¸€ä¸ªç½‘æ ¼ï¼Œä¼šè¢«åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼Œç»¿è‰²ç‚¹æ˜¯ GT ä¸­å¿ƒç‚¹ï¼Œè“è‰²ç‚¹æ˜¯åŒ¹é…ç»™ GT çš„æ­£æ ·æœ¬ç‚¹ã€‚é¦–å…ˆ GT ä¸­å¿ƒç‚¹æ‰€åœ¨çš„ç½‘æ ¼ä¼šè¢«å®šä¹‰ä¸ºæ­£æ ·æœ¬ï¼Œç„¶åæ ¹æ®ä¸­å¿ƒç‚¹åœ¨ç½‘æ ¼çš„ä½ç½®æ¥æ‰¾åˆ°å¦å¤–ä¸¤ä¸ªæ­£æ ·æœ¬ã€‚æ¯”å¦‚åœ¨ä½ç½® 1 æ˜¯å·¦ä¸Šçš„ç‚¹ä¼šè¢«å®šä¹‰ä¸ºå…¶æ­£æ ·æœ¬ï¼Œä½ç½® 2 æ˜¯å³ä¸Šï¼Œä½ç½® 3 æ˜¯å·¦ä¸‹ï¼Œä½ç½® 4 æ˜¯å³ä¸‹ ğŸ“šä¸‹é¢æ˜¯ä»£ç çš„æ³¨è§£å’Œè®²è§£ï¼š...",
          url: "/ai/2022/11/06/yolov7.html"
        },
      
        {
          title: "Rank &amp; Sort Loss è§£è¯»",
          content: "Rank &amp;amp; Sort Loss for Object Detection and Instance Segmentation è¿™ç¯‡æ–‡ç« ç®—æ˜¯æˆ‘è¯»çš„ detection æ–‡ç« é‡Œé¢æ¯”è¾ƒéš¾ç†è§£çš„ï¼ŒåŸå› å¯èƒ½åœ¨äºï¼šåˆ›æ–°çš„ç‚¹è·Ÿæ™®é€šçš„ä¹Ÿä¸å¤ªä¸€æ ·ï¼›æ–‡ç« é‡Œé¢æ¯”è¾ƒå¤šå…¬å¼ã€‚ä½†ä¹‹å‰ä¹Ÿæœ‰è·Ÿè¿™æ–¹é¢çš„å·¥ä½œå¦‚ AP Lossã€aLRPLoss ç­‰ã€‚å®ƒä»¬éƒ½æ˜¯ä¸ºäº†è§£å†³ä¸€ä¸ªé—®é¢˜ï¼šå•é˜¶æ®µç›®æ ‡æ£€æµ‹å™¨åˆ†ç±»å’Œå›å½’åœ¨è®­ç»ƒå’Œé¢„æµ‹ä¸ä¸€è‡´çš„é—®é¢˜ã€‚é‚£ä¹ˆ Rank &amp;amp; Sort Loss åˆåœ¨ä»¥ä¸Šçš„å·¥ä½œè¿›è¡Œäº†ä»€ä¹ˆæ”¹è¿›å‘¢ï¼Ÿåˆè§£å†³äº†ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ å…³äºè®­ç»ƒé¢„æµ‹ä¸ä¸€è‡´çš„é—®é¢˜ ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åœ¨åˆ†ç±»å’Œå›å½’åœ¨è®­ç»ƒçš„æ—¶å€™æ˜¯åˆ†å¼€çš„è®­ç»ƒï¼Œè®¡ç®— loss å¹¶è¿›è¡Œåå‘ä¼˜åŒ–ã€‚ä½†æ˜¯åœ¨é¢„æµ‹çš„æ—¶å€™å´æ˜¯ç”¨åˆ†ç±»åˆ†æ•°æ’åºæ¥è¿›è¡Œ nms åå¤„ç†ã€‚è¿™é‡Œå¯èƒ½å¯¼è‡´ä¸€ç§æƒ…å†µå°±æ˜¯åˆ†ç±»åˆ†æ•°å¾ˆé«˜ï¼Œä½†æ˜¯å›å½’ä¸å¥½ï¼ˆè¿™ä¸ªé—®é¢˜åœ¨ FCOS ä¸­æœ‰é˜è¿°ï¼‰ã€‚ ä¹‹å‰çš„å·¥ä½œ å¸¸è§çš„ç›®æ ‡æ£€æµ‹ç½‘ç»œä¸€èˆ¬ä¼šä½¿ç”¨ nms ä½œä¸ºåå¤„ç†ï¼Œè¿™æ—¶æˆ‘ä»¬å¸¸å¸¸å¸Œæœ›æ‰€æœ‰æ­£æ ·æœ¬çš„å¾—åˆ†æ’åœ¨è´Ÿæ ·æœ¬å‰é¢ï¼Œå¦å¤–æˆ‘ä»¬è¿˜å¸Œæœ›ä½ç½®é¢„æµ‹æ›´å‡†ç¡®çš„æ¡†æœ€åè¢«ç•™ä¸‹æ¥ã€‚ä¹‹å‰çš„ AP Loss å’Œ aLRP Loss ç”±äºéœ€è¦é™„åŠ çš„ head æ¥è¿›è¡Œåˆ†ç±»ç²¾åº¦å’Œä½ç½®ç²¾åº¦ç»¼åˆè¯„ä»·ï¼ˆå…¶å®å°±æ˜¯ä¸ºäº†æ¶ˆé™¤åˆ†ç±»å’Œå›å½’çš„ä¸ä¸€è‡´é—®é¢˜ï¼Œå¦‚ FCOS çš„ centernessã€IoU head ä¹‹ç±»çš„ï¼‰ï¼Œç¡®å®åœ¨è§£å†³ç±»åˆ«ä¸å‡è¡¡é—®é¢˜ï¼ˆæ­£è´Ÿæ ·æœ¬ä¸å‡è¡¡ï¼‰ç­‰æœ‰ç€ä¸é”™çš„æ•ˆæœï¼Œä½†æ˜¯éœ€è¦æ›´å¤šçš„æ—¶é—´å’Œæ•°æ®å¢å¼ºæ¥è¿›è¡Œè®­ç»ƒã€‚ Rank &amp;amp; Sort Loss...",
          url: "/ai/2022/08/08/Rank-Sort-Loss.html"
        },
      
        {
          title: "å˜é™ç§¯åˆ†æ±‚å¯¼çš„ç§ç§",
          content: "å˜ä¸Šé™ç§¯åˆ†æ±‚å¯¼çš„ç†è§£ å‡è®¾ \(F(x)\) æ˜¯ \(f(x)\) çš„ä¸€ä¸ªåŸå‡½æ•°ï¼Œå³ \(F^{\prime}(x) = f(x)\)ã€‚é‚£ä¹ˆå¯¹ \(f(x)\) ç§¯åˆ†ï¼Œæœ‰ï¼š \[\int f(x) dx = \int F^{\prime}(x) dx= F(x) +C\] å…¶ä¸­ \(C\) æ˜¯å¸¸æ•°ï¼Œå¯ä»¥å°†å…¶è¡¨ç¤ºä¸º \(-F(a)\)ã€‚å¦‚æœ \(f(x)\) åœ¨ \([a, x]\) ä¸Šè¿ç»­ï¼Œæˆ‘ä»¬å¯¹å…¶è¿›è¡Œç§¯åˆ†ï¼š \[\int_{a}^{x} f(t) dt = \int_{a}^{x} F^{\prime}(t) dt= F(x) - F(a) = F(x) + C\] å› æ­¤ï¼Œå…¶ä¸­æˆ‘ä»¬ç§° \(\int_{a}^{x}f(t)dt\) ä¸º \(f(x)\) çš„å˜ä¸Šé™ç§¯çš„å®šç§¯åˆ†ï¼Œä¹Ÿç®—æ˜¯ \(f(x)\) çš„ä¸€ä¸ªåŸå‡½æ•°ã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å¾—åˆ°ç‰›é¡¿-è±å¸ƒå°¼èŒ¨...",
          url: "/math/2022/06/05/%E5%8F%98%E9%99%90%E7%A7%AF%E5%88%86%E6%B1%82%E5%AF%BC.html"
        },
      
        {
          title: "Tufte-style Jekyll blog",
          content: "The Tufte Jekyll theme is an attempt to create a website design with the look and feel of Edward Tufteâ€™s books and handouts. Tufteâ€™s style is known for its extensive use of sidenotes, tight integration of graphics with text, and well-set typography. The idea for this project is essentially cribbed...",
          url: "/%E6%95%99%E7%A8%8B/2020/04/13/tufte-style-jekyll-blog.html"
        },
      
    ];

    // è·å– DOM å…ƒç´ 
    const searchInput = document.getElementById("search-input");
    const searchResults = document.getElementById("search-results");

    // ç›‘å¬è¾“å…¥æ¡†çš„å˜åŒ–
    searchInput.addEventListener("input", function () {
      const query = this.value.trim().toLowerCase();

      // æ¸…ç©ºç»“æœå®¹å™¨
      searchResults.innerHTML = "";
      searchResults.style.display = "none";

      if (!query) return;

      // è¿‡æ»¤åŒ¹é…çš„æ–‡ç« 
      const results = articles.filter((article) => {
        return (
          article.title.toLowerCase().includes(query) ||
          article.content.toLowerCase().includes(query)
        );
      });

      // æˆªæ–­ç»“æœä¸ºæœ€å¤š 10 æ¡
      const limitedResults = results.slice(0, 50);

      // æ˜¾ç¤ºæœç´¢ç»“æœ
      if (limitedResults.length > 0) {
        limitedResults.forEach((result) => {
          const resultItem = document.createElement("a");
          resultItem.href = result.url;
          resultItem.textContent = result.title;
          resultItem.title = result.content; // æç¤ºéƒ¨åˆ†å†…å®¹
          searchResults.appendChild(resultItem);
        });
        searchResults.style.display = "block";
      } else {
        // æ˜¾ç¤ºæ— ç»“æœæç¤º
        const noResult = document.createElement("div");
        noResult.textContent = "No Result or Error Title";
        noResult.style.padding = "20px 20px";
        noResult.style.color = "#082567";
        searchResults.appendChild(noResult);
        searchResults.style.display = "block";
      }
    });

    // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸæ—¶éšè—æœç´¢ç»“æœ
    document.addEventListener("click", function (e) {
      if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = "none";
      }
    });

    // è¿”å›é¡¶éƒ¨åŠŸèƒ½å®ç°
    document.addEventListener('DOMContentLoaded', () => {
      const backToTop = document.getElementById('backToTop');

      // æ»šåŠ¨ç›‘å¬ [[7]]
      window.addEventListener('scroll', () => {
        if (window.pageYOffset > 100) {
          backToTop.classList.add('show');
        } else {
          backToTop.classList.remove('show');
        }
      });

      // å¹³æ»‘æ»šåŠ¨ [[9]]
      backToTop.addEventListener('click', (e) => {
        e.preventDefault();
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    });

    function generateTOC() {
      const toc = document.getElementById('toc');
      const headings = document.querySelectorAll('h1, h2');

      headings.forEach(heading => {
        if (!heading.id) {
          // ä½¿ç”¨æ ‡å‡†åŒ–ç¼–ç æ–¹å¼
          heading.id = encodeURIComponent(
            heading.textContent
              .toLowerCase()
              .replace(/[^a-z0-9]/g, '-') // æ›¿æ¢æ‰€æœ‰éå­—æ¯æ•°å­—å­—ç¬¦
          );
        }

        const link = document.createElement('a');
        link.href = `#${heading.id}`;
        link.textContent = heading.textContent;
        link.classList.add('toc-link', `level-${heading.tagName[1]}`);

        if (heading.tagName === 'H2') {
          const parentDiv = toc.lastChild;
          if (parentDiv?.classList.contains('toc-parent')) {
            parentDiv.querySelector('.child-container').appendChild(link);
          }
        } else {
          const parentDiv = document.createElement('div');
          parentDiv.className = 'toc-parent';

          const toggleBtn = document.createElement('button');
          toggleBtn.className = 'toggle-btn';
          toggleBtn.textContent = 'â™ ';
          toggleBtn.addEventListener('click', () => {
            const child = parentDiv.querySelector('.child-container');
            child.classList.toggle('open');
            toggleBtn.textContent = child.classList.contains('open') ? 'â™¥' : 'â™ ';
          });

          const childContainer = document.createElement('div');
          childContainer.className = 'child-container';

          parentDiv.appendChild(toggleBtn);
          parentDiv.appendChild(link);
          parentDiv.appendChild(childContainer);
          toc.appendChild(parentDiv);
        }
      });
    }

    // æ»šåŠ¨ç›‘å¬ä¸é«˜äº® [[7]][[9]]
    window.addEventListener('scroll', () => {
      let currentSection = '';
      const scrollY = window.scrollY + 50; // åç§»é‡ä¼˜åŒ–

      document.querySelectorAll('h1, h2').forEach(section => {
        if (section.offsetTop <= scrollY) {
          currentSection = section.id;
        }
      });

      document.querySelectorAll('.toc-link').forEach(link => {
        link.classList.remove('active');
        if (link.hash === `#${currentSection}`) {
          link.classList.add('active');
          // è‡ªåŠ¨å±•å¼€çˆ¶å®¹å™¨
          const parent = link.closest('.toc-parent');
          if (parent) {
            parent.querySelector('.child-container').classList.add('open');
            parent.querySelector('.toggle-btn').textContent = 'â™¥';
          }
        }
      });
    });

    // ä¿®å¤å¹³æ»‘æ»šåŠ¨å¹¶æ·»åŠ è‡ªåŠ¨æŠ˜å åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', () => {
      generateTOC();

      // æ–°å¢æ»šåŠ¨æ–¹å‘æ£€æµ‹ [[5]]
      let lastScrollPosition = window.scrollY;
      window.addEventListener('scroll', () => {
        const currentScroll = window.scrollY;
        const isScrollingUp = currentScroll < lastScrollPosition;

        // æ›´æ–°æ»šåŠ¨ä½ç½®è®°å½•
        lastScrollPosition = currentScroll;

        let currentSection = '';
        const scrollY = currentScroll + 100; // åç§»é‡ä¼˜åŒ–

        document.querySelectorAll('h2').forEach(section => {
          if (section.offsetTop <= scrollY) {
            currentSection = section.id;
          }
        });

        // å…³é—­æ‰€æœ‰éå½“å‰æ ‡é¢˜çš„å±•å¼€çŠ¶æ€
        document.querySelectorAll('.toc-parent').forEach(parent => {
          const childContainer = parent.querySelector('.child-container');
          if (!parent.contains(document.querySelector(`#${currentSection}`))) {
            childContainer.classList.remove('open');
            parent.querySelector('.toggle-btn').textContent = 'â™ ';
          }
        });

        // å¤„ç†å½“å‰æ¿€æ´»æ ‡é¢˜
        const activeLink = document.querySelector(`.toc-link[href="#${currentSection}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
          activeLink.closest('.toc-parent').querySelector('.child-container').classList.add('open');
          activeLink.closest('.toc-parent').querySelector('.toggle-btn').textContent = 'â™¥';
        } else {
          document.querySelectorAll('.toc-link').forEach(link => link.classList.remove('active'));
        }

        // ç‰¹æ®Šå¤„ç†å‘ä¸Šæ»šåŠ¨åœºæ™¯ [[7]]
        if (isScrollingUp) {
          setTimeout(() => {
            document.querySelectorAll('.child-container.open').forEach(container => {
              if (container.getBoundingClientRect().top > window.innerHeight) {
                container.classList.remove('open');
                container.previousElementSibling.textContent = 'â™ ';
              }
            });
          }, 100);
        }
      });

      // ä¿®æ­£å¹³æ»‘æ»šåŠ¨ [[10]]
      document.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = decodeURIComponent(link.hash); // è§£ç å¤„ç†
          const targetElement = document.querySelector(targetId);

          if (targetElement) {
            targetElement.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        });
      });
    });
    </script>
    <span class="print-footer">YoloV7 æ ‡ç­¾åŒ¹é…åŠ loss è®¡ç®—è§£æ - November 6, 2022 - L77</span>
    <footer>
  <hr class="slender_footer">
  <ul class="footer-links">   
    
      <li>
        <a href="//www.add-my-qq.com/2959807018"><span class="icon-QQ"></span></a>
      </li>
    
      <li>
        <a href="//github.com/FL77N"><span class="icon-github"></span></a>
      </li>
    
      <li>
        <a href="//www.zhihu.com/people/FromL77"><span class="icon-zhihu"></span></a>
      </li>
      
  </ul>
<div class="credits">
<span class="footer_word">&copy; 2025-2025 &nbsp;&nbsp;L77</span></br> <br>
<span class="footer_word">Powered By Jekyll And Tufte Theme</span>
</div>  
</footer>
    <!-- åœ¨bodyåº•éƒ¨æ–°å¢æŒ‰é’® -->
    <button id="backToTop" class="back-to-top">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor"
              d="M12 4l8 8H16v8H8v-8H4l8-8z"
              style="transform: rotate(0deg); transition: 0.3s;"/>
      </svg>
    </button>
  </body>
</html>